<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Grid API Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1 {
      color: #4CAF50;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    h2 {
      color: #FF9800;
      margin-top: 30px;
    }
    .test-section {
      background: #2a2a2a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #444;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #45a049;
    }
    button.secondary {
      background: #757575;
    }
    button.secondary:hover {
      background: #616161;
    }
    .output {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #333;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .status.success {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
      color: #4CAF50;
    }
    .status.error {
      background: rgba(244, 67, 54, 0.2);
      border: 1px solid #f44336;
      color: #f44336;
    }
    .status.info {
      background: rgba(33, 150, 243, 0.2);
      border: 1px solid #2196F3;
      color: #2196F3;
    }
    .grid-test {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    .test-point {
      background: #1e1e1e;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #444;
    }
    .test-point h4 {
      margin: 0 0 10px 0;
      color: #4CAF50;
      font-size: 13px;
    }
    .test-point .coords {
      color: #888;
      font-size: 11px;
      margin-bottom: 5px;
    }
    .test-point .wind-data {
      font-size: 12px;
    }
    label {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>üåê Weather Grid API Test</h1>

  <div class="test-section">
    <h2>üì° Grid API Configuration</h2>
    <div class="controls">
      <label>
        <input type="checkbox" id="useGridAPI" checked disabled> Use Grid API (DWD ICON)
      </label>
      <span style="margin-left: 20px; font-size: 11px; opacity: 0.7;">
        Fetches weather data for entire Slovenia grid (~1,200 points)
      </span>
    </div>
    <div class="controls">
      <button onclick="loadGridData()">Load Grid Data</button>
      <button onclick="testInterpolation()" class="secondary">Test Interpolation</button>
      <button onclick="clearCache()" class="secondary">Clear Cache</button>
    </div>
    <div id="gridStatus" class="status info">
      Ready to load grid data
    </div>
  </div>

  <div class="test-section">
    <h2>üó∫Ô∏è Grid Information</h2>
    <div id="gridInfo" class="output">
      Load grid data to see information...
    </div>
  </div>

  <div class="test-section">
    <h2>üéØ Interpolation Test Points</h2>
    <p style="opacity: 0.8; font-size: 13px;">
      Testing wind interpolation at specific locations across Slovenia:
    </p>
    <div id="testPoints" class="grid-test">
      <!-- Test points will be populated here -->
    </div>
  </div>

  <div class="test-section">
    <h2>üìä Raw Grid Data (First Level)</h2>
    <div id="rawGridData" class="output">
      Load grid data to see raw arrays...
    </div>
  </div>

  <script type="module">
    import { WeatherDataManager } from './weather-data-manager.js';
    import { getCardinalDirection } from './wind-arrow-textures.js';

    let dataManager;
    let currentGridData = null;

    // Test points across Slovenia
    const testPoints = [
      { name: 'Ljubljana (Center)', lat: 46.05, lon: 14.5 },
      { name: 'Maribor (NE)', lat: 46.55, lon: 15.65 },
      { name: 'Koper (SW Coast)', lat: 45.55, lon: 13.73 },
      { name: 'Kranj (N)', lat: 46.24, lon: 14.36 },
      { name: 'Novo Mesto (SE)', lat: 45.80, lon: 15.17 },
      { name: 'Celje (E)', lat: 46.23, lon: 15.27 }
    ];

    // Initialize
    async function init() {
      // Create data manager with grid API enabled
      dataManager = new WeatherDataManager({ useGridAPI: true });
      console.log('[Test] WeatherDataManager initialized with Grid API');

      updateStatus('Ready to load grid data', 'info');
    }

    // Load grid data
    window.loadGridData = async function() {
      updateStatus('Loading grid data from DWD ICON API...', 'info');

      try {
        currentGridData = await dataManager.getWindData({ forceRefresh: true });
        updateStatus(`‚úì Grid data loaded successfully!`, 'success');
        displayGridInfo(currentGridData);
        displayRawGridData(currentGridData);

        // Enable interpolation test
        document.querySelector('button[onclick="testInterpolation()"]').disabled = false;
      } catch (error) {
        updateStatus(`‚úó Error loading grid: ${error.message}`, 'error');
        console.error(error);
      }
    };

    // Test interpolation
    window.testInterpolation = function() {
      if (!currentGridData || !currentGridData.grid) {
        updateStatus('‚ö†Ô∏è Load grid data first', 'error');
        return;
      }

      updateStatus('Testing bilinear interpolation at multiple points...', 'info');

      const testPointsDiv = document.getElementById('testPoints');
      testPointsDiv.innerHTML = '';

      testPoints.forEach(point => {
        // Get interpolated wind at Low Cruise (850 hPa)
        const windData = dataManager.getWindAtLocation(
          currentGridData,
          point.lat,
          point.lon,
          'low_cruise_850hPa'
        );

        const div = document.createElement('div');
        div.className = 'test-point';

        const dir = getCardinalDirection(windData.winddirection_deg);

        div.innerHTML = `
          <h4>${point.name}</h4>
          <div class="coords">${point.lat.toFixed(2)}¬∞N, ${point.lon.toFixed(2)}¬∞E</div>
          <div class="wind-data">
            <strong>Wind Speed:</strong> ${windData.windspeed_kmh.toFixed(1)} km/h<br>
            <strong>Direction:</strong> ${windData.winddirection_deg.toFixed(0)}¬∞ (${dir})<br>
            <strong>Temperature:</strong> ${windData.temperature_c.toFixed(1)}¬∞C
          </div>
        `;

        testPointsDiv.appendChild(div);
      });

      updateStatus('‚úì Interpolation test complete', 'success');
    };

    // Clear cache
    window.clearCache = function() {
      dataManager.clearCache();
      currentGridData = null;
      updateStatus('‚úì Cache cleared', 'success');
    };

    // Update status display
    function updateStatus(message, type) {
      const statusDiv = document.getElementById('gridStatus');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;

      // Add data source info if available
      const info = dataManager.getDataSourceInfo();
      if (info.source) {
        statusDiv.textContent += `\n\nSource: ${info.source}`;
        statusDiv.textContent += `\nGrid API: ${info.usingGridAPI ? 'ENABLED' : 'disabled'}`;
        statusDiv.textContent += `\nBounds: ${info.gridBounds.latMin}¬∞N - ${info.gridBounds.latMax}¬∞N`;
        if (info.lastApiCall) {
          const age = Math.round((Date.now() - info.lastApiCall) / 1000);
          statusDiv.textContent += `\nLast API call: ${age}s ago`;
        }
      }
    }

    // Display grid information
    function displayGridInfo(data) {
      const infoDiv = document.getElementById('gridInfo');
      let html = '';

      html += `<strong>Grid API Response:</strong>\n`;
      html += '‚îÄ'.repeat(80) + '\n\n';

      html += `<strong>Timestamp:</strong> ${data.timestamp}\n\n`;

      html += `<strong>Grid Coverage:</strong>\n`;
      if (data.location && data.location.latitude_range) {
        html += `  Latitude:  ${data.location.latitude_range[0]}¬∞N to ${data.location.latitude_range[1]}¬∞N\n`;
        html += `  Longitude: ${data.location.longitude_range[0]}¬∞E to ${data.location.longitude_range[1]}¬∞E\n`;
        html += `  Resolution: ${data.location.grid_resolution}¬∞ (~7 km)\n\n`;
      } else {
        html += `  ERROR: Missing location data\n\n`;
        console.error('[Test] data.location:', data.location);
      }

      if (data.grid && data.grid.latitudes && data.grid.longitudes) {
        html += `<strong>Grid Dimensions:</strong>\n`;
        html += `  Latitudes:  ${data.grid.latitudes.length} points\n`;
        html += `  Longitudes: ${data.grid.longitudes.length} points\n`;
        html += `  Total Grid Points: ${data.grid.latitudes.length * data.grid.longitudes.length}\n\n`;
      } else {
        html += `<strong>Grid Dimensions:</strong> ERROR - Missing grid data\n\n`;
        console.error('[Test] data.grid:', data.grid);
      }

      if (data.grid && data.grid.wind_data) {
        html += `<strong>Available Levels:</strong>\n`;
        Object.keys(data.grid.wind_data).forEach((levelKey, i) => {
          html += `  ${i + 1}. ${levelKey}\n`;
        });

        html += `\n<strong>Sample Grid Point (0, 0):</strong>\n`;
        const firstLevel = Object.keys(data.grid.wind_data)[0];
        const levelData = data.grid.wind_data[firstLevel];
        html += `  Level: ${firstLevel}\n`;
        html += `  Location: ${data.grid.latitudes[0]}¬∞N, ${data.grid.longitudes[0]}¬∞E\n`;
        html += `  Wind Speed: ${levelData.windspeed[0]?.[0] || 'N/A'} km/h\n`;
        html += `  Wind Direction: ${levelData.winddirection[0]?.[0] || 'N/A'}¬∞\n`;
        html += `  Temperature: ${levelData.temperature[0]?.[0] || 'N/A'}¬∞C\n`;
      } else {
        html += `<strong>Wind Data:</strong> ERROR - Missing wind_data\n`;
        console.error('[Test] data.grid.wind_data:', data?.grid?.wind_data);
      }

      infoDiv.textContent = html;
    }

    // Display raw grid data
    function displayRawGridData(data) {
      const rawDiv = document.getElementById('rawGridData');

      const firstLevel = Object.keys(data.grid.wind_data)[0];
      const levelData = data.grid.wind_data[firstLevel];

      let html = `<strong>Raw Grid Arrays for ${firstLevel}:</strong>\n\n`;

      html += `<strong>Wind Speed Grid (first 5 lat √ó 5 lon):</strong>\n`;
      for (let i = 0; i < Math.min(5, levelData.windspeed.length); i++) {
        html += `Lat ${data.grid.latitudes[i].toFixed(2)}¬∞: `;
        for (let j = 0; j < Math.min(5, levelData.windspeed[i]?.length || 0); j++) {
          html += `${levelData.windspeed[i][j].toFixed(1).padStart(6)}`;
        }
        html += ' ...\n';
      }

      html += `\n<strong>Wind Direction Grid (first 5 lat √ó 5 lon):</strong>\n`;
      for (let i = 0; i < Math.min(5, levelData.winddirection.length); i++) {
        html += `Lat ${data.grid.latitudes[i].toFixed(2)}¬∞: `;
        for (let j = 0; j < Math.min(5, levelData.winddirection[i]?.length || 0); j++) {
          html += `${levelData.winddirection[i][j].toFixed(0).padStart(6)}`;
        }
        html += ' ...\n';
      }

      rawDiv.textContent = html;
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
